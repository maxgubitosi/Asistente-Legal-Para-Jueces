version: "3.9"

services:
# --------------------------------------------------- Qdrant
  qdrant:
    image: qdrant/qdrant:v1.9.1
    ports: ["6333:6333"]
    volumes: [qdrant_data:/qdrant/storage]

# ---------------------------------- Backend (índices + FastAPI)
  backend:
    build: .
    depends_on: [qdrant]
    env_file: [.env]
    environment:
      QDRANT_URL: "http://qdrant:6333"
    volumes:
      - ../datasets:/datasets
      - ./bm25_cache:/indexes    # ←─ comando directo para uvicorn
    command: ["bash", "/app/scripts/build_and_start.sh"]
    expose: ["8000"]

# ---------------------------------- UI Streamlit
  streamlit:
    build: .
    container_name: rag-ui
    depends_on: [backend]
    environment:
      API_URL: "http://backend:8000/query"   # URL interna
    command: >
      streamlit run frontend/ui.py
        --server.port 8501
        --server.address 0.0.0.0
    ports: ["8501:8501"]

volumes:
  qdrant_data:
  bm25_cache:
